name: Docker Image

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -e .[dev]

      - name: Run pre-commit
        run: pre-commit run --all-files

      - name: Run tests
        run: python -m scripts.run_tests
        env:
          SENTIENTOS_CI_REQUIRE_DEFAULT_INTENT: "1"
          SENTIENTOS_CI_MIN_PASSED: "1"
          SENTIENTOS_CI_MAX_SKIP_RATE: "0.20"
          SENTIENTOS_CI_MAX_XFAIL_RATE: "0.10"

      - name: Analyze test provenance trends
        if: always()
        run: python scripts/analyze_test_provenance.py --dir glow/test_runs/provenance --verify-chain

      - name: Analyze router telemetry trends
        if: always()
        run: python scripts/analyze_test_provenance.py --dir glow/test_runs/provenance --verify-chain --output glow/test_runs/router_telemetry_report.json

      - name: Upload test run provenance
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test_run_provenance_${{ github.run_id }}_${{ github.job }}
          path: |
            glow/test_runs/test_run_provenance.json
            glow/test_runs/provenance/*.json

      - name: Upload test trend report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test_trend_report_${{ github.run_id }}_${{ github.job }}
          path: glow/test_runs/test_trend_report.json


      - name: Upload router telemetry report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: router_telemetry_report_${{ github.run_id }}_${{ github.job }}
          path: glow/test_runs/router_telemetry_report.json
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: ghcr.io/zombinator85/sentientos:latest
          context: .
